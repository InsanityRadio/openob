#!/usr/bin/env python3

#import daemon
import lockfile
import signal
import configparser
import os
import argparse
import logging
from openob.node import Node

parser = argparse.ArgumentParser()
parser.add_argument("--config", help="Optional configuration file path")
args = parser.parse_args()

config = configparser.ConfigParser()
config.read(['/etc/openobd.conf', os.path.expanduser('~/.openobd.conf')])
if args.config:
    res = config.read(args.config)
    if args.config not in res:
        raise FileNotFoundError("Couldn't read config file", args.config)

audio_interfaces = {}

# Generate audio interface config from the config file
for sec in config.sections():
    if "interface:" in sec:
        # This is an interface definition, parse it
        audio_interfaces[sec] = config[sec]


node = Node()
node.setup(config.get('openob', 'node_id'),
           config.get('zookeeper', 'config_hosts'),
           audio_interfaces,
           getattr(logging, config.get('logging', 'log_level').upper()))
node.run()
# FIXME: The daemon stuff isn't working for some reason.
# context = daemon.DaemonContext(
#     working_directory='/tmp',
#     pidfile=lockfile.FileLock('/var/run/openobd.pid'),
#     )
# context.signal_map = {
#     signal.SIGTERM: node.shutdown(),
#     signal.SIGHUP: 'terminate',
#     }
# with context:
#     print("Running")
